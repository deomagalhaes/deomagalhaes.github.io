<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festival de Pipas - Corrida dos C√©us</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap' );
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: hsl(210, 100%, 50%); --primary-dark: hsl(210, 100%, 40%); --secondary: hsl(45, 100%, 60%);
            --accent: hsl(330, 100%, 60%); --success: hsl(120, 60%, 50%); --danger: hsl(0, 80%, 60%);
            --background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 30%, #B0E0E6 60%, #E0F6FF 100%);
            --card-bg: rgba(255, 255, 255, 0.95); --shadow: 0 20px 40px rgba(0,0,0,0.1);
            --glow: 0 0 30px rgba(74, 144, 226, 0.5);
        }
        body { font-family: 'Fredoka', cursive; background: var(--background); min-height: 100vh; overflow-x: hidden; position: relative; }
        .clouds-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; }
        .cloud-bg { position: absolute; background: rgba(255, 255, 255, 0.6); border-radius: 100px; animation: drift 25s infinite linear; }
        .cloud-bg::before, .cloud-bg::after { content: ''; position: absolute; background: rgba(255, 255, 255, 0.6); border-radius: 100px; }
        .cloud-bg:nth-child(1) { width: 120px; height: 60px; top: 10%; animation-duration: 30s; }
        .cloud-bg:nth-child(2) { width: 80px; height: 40px; top: 30%; animation-duration: 25s; animation-delay: -8s; }
        .cloud-bg:nth-child(3) { width: 100px; height: 50px; top: 60%; animation-duration: 35s; animation-delay: -15s; }
        @keyframes drift { from { transform: translateX(-200px); } to { transform: translateX(calc(100vw + 200px)); } }
        .app-container { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 25px; padding: 30px; text-align: center; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid rgba(255, 255, 255, 0.3); }
        .header h1 { background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 3rem; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header p { color: #666; font-size: 1.2rem; font-weight: 500; }
        .status-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .status-card { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; text-align: center; box-shadow: var(--shadow); border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; }
        .status-card:hover { transform: translateY(-5px); box-shadow: 0 25px 50px rgba(0,0,0,0.15); }
        .status-label { font-size: 0.9rem; color: #666; margin-bottom: 8px; font-weight: 500; }
        .status-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .kite-selection { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 25px; padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid rgba(255, 255, 255, 0.3); }
        .kite-selection h2 { text-align: center; color: #333; font-size: 1.8rem; margin-bottom: 20px; font-weight: 600; }
        .kite-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .kite-option { background: rgba(255, 255, 255, 0.7); border: 3px solid transparent; border-radius: 20px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .kite-option::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, var(--primary), var(--accent)); opacity: 0; transition: opacity 0.3s ease; z-index: -1; }
        .kite-option:hover { transform: translateY(-5px); box-shadow: var(--glow); }
        .kite-option.selected { border-color: var(--primary); box-shadow: var(--glow); }
        .kite-option.selected::before { opacity: 0.1; }
        .kite-preview { width: 60px; height: 60px; margin: 0 auto 15px; position: relative; }
        .kite-mini { background: linear-gradient(45deg, #FF6B6B, #FF8E53); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .kite-tradicional { background: linear-gradient(45deg, #4ECDC4, #44A08D); clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }
        .kite-peixe { background: linear-gradient(45deg, #FFD93D, #FF6B6B); border-radius: 50px 10px 50px 10px; }
        .kite-flecha { background: linear-gradient(45deg, #6C5CE7, #A29BFE); clip-path: polygon(50% 0%, 0% 100%, 50% 75%, 100% 100%); }
        .kite-name { font-weight: 600; color: #333; margin-bottom: 5px; }
        .kite-stats { font-size: 0.9rem; color: #666; }
        .game-area { position: relative; width: 100%; height: 500px; background: linear-gradient(180deg, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%); border-radius: 25px; overflow: hidden; box-shadow: inset 0 10px 30px rgba(0,0,0,0.1); border: 3px solid rgba(255, 255, 255, 0.3); margin-bottom: 25px; }
        .race-track { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient( 90deg, transparent, transparent 48px, rgba(255, 255, 255, 0.1) 48px, rgba(255, 255, 255, 0.1) 50px ); }
        .player-kite { position: absolute; top: 0; left: 50px; width: 50px; height: 50px; z-index: 10; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); cursor: grab; user-select: none; will-change: transform; }
        .player-kite:active { cursor: grabbing; }
        .obstacle-kite { position: absolute; width: 40px; height: 40px; will-change: transform; filter: drop-shadow(0 3px 10px rgba(0,0,0,0.2)); }
        .explosion { position: absolute; width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #FF6B6B, #FF8E53, transparent); animation: explode 0.5s ease-out forwards; z-index: 15; }
        @keyframes explode { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .controls { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 15px 30px; font-size: 1.2rem; font-weight: 600; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; font-family: inherit; position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; }
        .btn:hover::before { left: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 10px 25px rgba(74, 144, 226, 0.3); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(74, 144, 226, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #95A5A6, #7F8C8D); color: white; box-shadow: 0 10px 25px rgba(149, 165, 166, 0.3); }
        .btn-secondary:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(149, 165, 166, 0.4); }
        .btn-accent { background: linear-gradient(135deg, var(--accent), #E91E63); color: white; box-shadow: 0 10px 25px rgba(233, 30, 99, 0.3); }
        .btn-accent:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(233, 30, 99, 0.4); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 25px; padding: 40px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 30px 60px rgba(0,0,0,0.3); border: 1px solid rgba(255, 255, 255, 0.3); animation: modalIn 0.3s ease-out; }
        @keyframes modalIn { from { transform: scale(0.8) translateY(50px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .modal h2 { text-align: center; color: #333; margin-bottom: 25px; font-size: 2rem; font-weight: 700; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(255, 255, 255, 0.7); border-radius: 15px; margin-bottom: 10px; transition: all 0.3s ease; }
        .leaderboard-item:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .rank { font-size: 1.5rem; font-weight: 700; color: var(--primary); min-width: 40px; }
        .record-info { flex: 1; margin-left: 15px; }
        .record-level { font-weight: 600; color: #333; }
        .record-score { font-size: 0.9rem; color: #666; }
        .message { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; margin: 20px 0; text-align: center; box-shadow: var(--shadow); border: 1px solid rgba(255, 255, 255, 0.3); font-size: 1.1rem; font-weight: 500; color: #333; }
        @media (max-width: 768px) { .app-container { padding: 15px; } .header h1 { font-size: 2.2rem; } .game-area { height: 400px; } .status-panel { grid-template-columns: repeat(2, 1fr); } .kite-options { grid-template-columns: repeat(2, 1fr); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .bounce { animation: bounce 0.6s ease-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .particle { position: absolute; width: 4px; height: 4px; background: var(--secondary); border-radius: 50%; pointer-events: none; animation: particle 1s ease-out forwards; }
        @keyframes particle { 0% { transform: scale(1) translateY(0); opacity: 1; } 100% { transform: scale(0) translateY(-50px); opacity: 0; } }
        .progress-indicator { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.3); border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s ease; border-radius: 3px; }
        .game-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 20; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .control-btn:hover { transform: scale(1.1); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .control-btn:active { transform: scale(0.95); }
        .audio-controls { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; gap: 10px; }
        .audio-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .audio-btn:hover { transform: scale(1.1); }
        .audio-btn.muted { opacity: 0.5; }
    </style>
</head>
<body>
    <div class="clouds-bg">
        <div class="cloud-bg"></div>
        <div class="cloud-bg"></div>
        <div class="cloud-bg"></div>
    </div>
    <div class="audio-controls">
        <button class="audio-btn" id="musicToggle" title="M√∫sica">üéµ</button>
        <button class="audio-btn" id="soundToggle" title="Efeitos">üîä</button>
    </div>
    <div class="app-container">
        <div class="header">
            <h1>ü™Å Festival de Pipas ü™Å</h1>
            <p>Corrida dos C√©us - Desvie dos obst√°culos e chegue ao fim!</p>
        </div>
        <div class="status-panel">
            <div class="status-card">
                <div class="status-label">N√≠vel</div>
                <div class="status-value" id="levelDisplay">1/10</div>
            </div>
            <div class="status-card">
                <div class="status-label">Pontua√ß√£o</div>
                <div class="status-value" id="scoreDisplay">0</div>
            </div>
            <div class="status-card">
                <div class="status-label">Dist√¢ncia</div>
                <div class="status-value" id="distanceDisplay">0m</div>
            </div>
            <div class="status-card">
                <div class="status-label">Recorde</div>
                <div class="status-value" id="recordDisplay">-</div>
            </div>
        </div>
        <div class="kite-selection" id="kiteSelection">
            <h2>Escolha sua Pipa</h2>
            <div class="kite-options">
                <div class="kite-option" data-type="mini">
                    <div class="kite-preview kite-mini"></div>
                    <div class="kite-name">Mini</div>
                    <div class="kite-stats">Velocidade: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê  
Resist√™ncia: ‚≠ê‚≠ê</div>
                </div>
                <div class="kite-option selected" data-type="tradicional">
                    <div class="kite-preview kite-tradicional"></div>
                    <div class="kite-name">Tradicional</div>
                    <div class="kite-stats">Velocidade: ‚≠ê‚≠ê‚≠ê‚≠ê  
Resist√™ncia: ‚≠ê‚≠ê‚≠ê</div>
                </div>
                <div class="kite-option" data-type="peixe">
                    <div class="kite-preview kite-peixe"></div>
                    <div class="kite-name">Peixe</div>
                    <div class="kite-stats">Velocidade: ‚≠ê‚≠ê‚≠ê  
Resist√™ncia: ‚≠ê‚≠ê‚≠ê‚≠ê</div>
                </div>
                <div class="kite-option" data-type="flecha">
                    <div class="kite-preview kite-flecha"></div>
                    <div class="kite-name">Flecha</div>
                    <div class="kite-stats">Velocidade: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê  
Resist√™ncia: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                </div>
            </div>
        </div>
        <div class="progress-indicator">
            <div class="progress-bar" id="phaseProgress"></div>
        </div>
        <div class="message" id="gameMessage">
            Escolha sua pipa e clique em "Iniciar Corrida" para come√ßar!
        </div>
        <div class="game-area" id="gameArea">
            <div class="race-track"></div>
            <div class="player-kite kite-tradicional" id="playerKite"></div>
            <div class="game-controls" id="gameControls" style="display: none;">
                <button class="control-btn" id="moveUp">‚¨ÜÔ∏è</button>
                <button class="control-btn" id="moveDown">‚¨áÔ∏è</button>
            </div>
        </div>
        <div class="controls">
            <button class="btn btn-primary" id="startBtn">Iniciar Corrida</button>
            <button class="btn btn-secondary" id="pauseBtn" style="display: none;">Pausar</button>
            <button class="btn btn-accent" id="leaderboardBtn">üèÜ Classifica√ß√µes</button>
            <button class="btn btn-secondary" id="resetBtn">Reiniciar</button>
        </div>
    </div>
    <div class="modal" id="leaderboardModal">
        <div class="modal-content">
            <h2>üèÜ Classifica√ß√µes</h2>
            <div id="leaderboardList">
                <p style="text-align: center; color: #666;">Nenhum recorde ainda. Jogue para estabelecer suas marcas!</p>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeLeaderboard()">Fechar</button>
                <button class="btn btn-accent" onclick="clearRecords()" style="margin-left: 10px;">Limpar Recordes</button>
            </div>
        </div>
    </div>
    <audio id="bgMusic" loop preload="auto"></audio>
    <audio id="moveSound" preload="auto"></audio>
    <audio id="crashSound" preload="auto"></audio>
    <audio id="levelUpSound" preload="auto"></audio>

    <script>
        const gameState = {
            level: 1, maxLevel: 10, score: 0, distance: 0, isPlaying: false, isPaused: false,
            selectedKite: 'tradicional', playerY: 225, obstacles: [], obstacleElements: new Map(),
            gameSpeed: 2, obstacleSpawnRate: 0.015, phaseStartTime: 0, phaseDuration: 20000,
            frameCount: 0, musicEnabled: true, soundEnabled: true, isDragging: false,
            gameStarted: false, lastUpdateTime: 0, particleCount: 0, maxParticles: 20
        };
        const levelConfigs = {
            1: { speed: 2, spawnRate: 0.015, duration: 20000, obstacleSpeed: 1.5 }, 2: { speed: 2.2, spawnRate: 0.018, duration: 20000, obstacleSpeed: 1.7 },
            3: { speed: 2.5, spawnRate: 0.022, duration: 20000, obstacleSpeed: 2 }, 4: { speed: 2.8, spawnRate: 0.025, duration: 20000, obstacleSpeed: 2.2 },
            5: { speed: 3, spawnRate: 0.028, duration: 20000, obstacleSpeed: 2.5 }, 6: { speed: 3.2, spawnRate: 0.032, duration: 20000, obstacleSpeed: 2.7 },
            7: { speed: 3.5, spawnRate: 0.035, duration: 20000, obstacleSpeed: 3 }, 8: { speed: 3.8, spawnRate: 0.038, duration: 20000, obstacleSpeed: 3.2 },
            9: { speed: 4, spawnRate: 0.042, duration: 20000, obstacleSpeed: 3.5 }, 10: { speed: 4.5, spawnRate: 0.045, duration: 20000, obstacleSpeed: 4 }
        };
        const elements = {
            levelDisplay: document.getElementById('levelDisplay'), scoreDisplay: document.getElementById('scoreDisplay'),
            distanceDisplay: document.getElementById('distanceDisplay'), recordDisplay: document.getElementById('recordDisplay'),
            gameMessage: document.getElementById('gameMessage'), gameArea: document.getElementById('gameArea'),
            playerKite: document.getElementById('playerKite'), startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'), resetBtn: document.getElementById('resetBtn'),
            leaderboardBtn: document.getElementById('leaderboardBtn'), kiteSelection: document.getElementById('kiteSelection'),
            gameControls: document.getElementById('gameControls'), phaseProgress: document.getElementById('phaseProgress'),
            leaderboardModal: document.getElementById('leaderboardModal'), musicToggle: document.getElementById('musicToggle'),
            soundToggle: document.getElementById('soundToggle'), bgMusic: document.getElementById('bgMusic'),
            moveSound: document.getElementById('moveSound'), crashSound: document.getElementById('crashSound'),
            levelUpSound: document.getElementById('levelUpSound')
        };
        document.addEventListener('DOMContentLoaded', () => {
            initializeGame();
            setupEventListeners();
            loadRecords();
            updateDisplay();
            createSynthAudio();
        });
        function initializeGame() {
            gameState.level = 1; gameState.score = 0; gameState.distance = 0; gameState.isPlaying = false;
            gameState.isPaused = false; gameState.playerY = 225; gameState.obstacles = [];
            gameState.obstacleElements.clear(); gameState.frameCount = 0; gameState.phaseStartTime = 0;
            gameState.gameStarted = false; gameState.particleCount = 0; gameState.lastUpdateTime = 0;
            const config = levelConfigs[gameState.level];
            gameState.gameSpeed = config.speed; gameState.obstacleSpawnRate = config.spawnRate; gameState.phaseDuration = config.duration;
            elements.playerKite.style.transform = `translateY(${gameState.playerY}px)`;
            elements.gameControls.style.display = 'none'; elements.pauseBtn.style.display = 'none';
            elements.startBtn.style.display = 'inline-block'; elements.kiteSelection.style.display = 'block';
        }
        function setupEventListeners() {
            document.querySelectorAll('.kite-option').forEach(option => { option.addEventListener('click', () => selectKite(option.dataset.type)); });
            elements.startBtn.addEventListener('click', startGame);
            elements.pauseBtn.addEventListener('click', togglePause);
            elements.resetBtn.addEventListener('click', resetGame);
            elements.leaderboardBtn.addEventListener('click', showLeaderboard);
            elements.playerKite.addEventListener('mousedown', startDrag);
            elements.gameArea.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', stopDrag);
            elements.gameArea.addEventListener('mouseleave', stopDrag);
            elements.playerKite.addEventListener('touchstart', startDragTouch, { passive: false });
            elements.gameArea.addEventListener('touchmove', handleDragTouch, { passive: false });
            document.addEventListener('touchend', stopDrag);
            document.addEventListener('keydown', handleKeyDown);
            elements.musicToggle.addEventListener('click', toggleMusic);
            elements.soundToggle.addEventListener('click', toggleSound);
            elements.leaderboardModal.addEventListener('click', (e) => { if (e.target === elements.leaderboardModal) { closeLeaderboard(); } });
        }
        function selectKite(type) {
            gameState.selectedKite = type;
            document.querySelectorAll('.kite-option').forEach(option => { option.classList.remove('selected'); });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            elements.playerKite.className = `player-kite kite-${type}`;
            playSound('move');
        }
        function startGame() {
            if (gameState.isPlaying) return;
            gameState.isPlaying = true; gameState.isPaused = false; gameState.frameCount = 0;
            gameState.phaseStartTime = Date.now(); gameState.lastUpdateTime = performance.now();
            gameState.obstacles = []; gameState.obstacleElements.clear(); gameState.particleCount = 0;
            gameState.gameStarted = true;
            elements.startBtn.style.display = 'none'; elements.pauseBtn.style.display = 'inline-block';
            elements.kiteSelection.style.display = 'none'; elements.gameControls.style.display = 'flex';
            elements.gameMessage.textContent = `N√≠vel ${gameState.level}/10 - Arraste sua pipa para desviar!`;
            if (gameState.musicEnabled) { playBackgroundMusic(); }
            requestAnimationFrame(gameLoop);
        }
        function gameLoop(currentTime) {
            if (!gameState.isPlaying || gameState.isPaused) return;
            const deltaTime = currentTime - gameState.lastUpdateTime;
            gameState.lastUpdateTime = currentTime;
            gameState.frameCount++;
            const elapsed = Date.now() - gameState.phaseStartTime;
            const timeLeft = Math.max(0, gameState.phaseDuration - elapsed);
            gameState.distance += gameState.gameSpeed;
            gameState.score += Math.floor(gameState.gameSpeed);
            const progress = (elapsed / gameState.phaseDuration) * 100;
            elements.phaseProgress.style.width = `${progress}%`;
            if (gameState.frameCount % 30 === 0) {
                const secondsLeft = Math.ceil(timeLeft / 1000);
                elements.gameMessage.textContent = `N√≠vel ${gameState.level}/10 - Tempo: ${secondsLeft}s`;
            }
            if (Math.random() < gameState.obstacleSpawnRate) { spawnObstacle(); }
            updateObstaclesOptimized();
            if (checkCollisions()) { gameOver(); return; }
            if (timeLeft <= 0) { levelComplete(); return; }
                        if (gameState.frameCount % 10 === 0) {
                updateDisplay();
            }
            if (gameState.frameCount % 45 === 0) {
                createSpeedLines();
            }
            requestAnimationFrame(gameLoop);
        }
        function spawnObstacle() {
            const obstacleId = `obstacle_${Date.now()}_${Math.random()}`;
            const obstacle = {
                id: obstacleId,
                x: elements.gameArea.offsetWidth,
                y: Math.random() * (elements.gameArea.offsetHeight - 100) + 50,
                type: ['mini', 'tradicional', 'peixe', 'flecha'][Math.floor(Math.random() * 4)],
                speed: levelConfigs[gameState.level].obstacleSpeed
            };
            gameState.obstacles.push(obstacle);
            const obstacleEl = document.createElement('div');
            obstacleEl.className = `obstacle-kite kite-${obstacle.type}`;
            obstacleEl.style.transform = `translateX(${obstacle.x}px) translateY(${obstacle.y}px)`;
            obstacleEl.id = obstacleId;
            gameState.obstacleElements.set(obstacleId, obstacleEl);
            elements.gameArea.appendChild(obstacleEl);
        }
        function updateObstaclesOptimized() {
            for (let i = gameState.obstacles.length - 1; i >= 0; i--) {
                const obstacle = gameState.obstacles[i];
                obstacle.x -= obstacle.speed;
                const obstacleEl = gameState.obstacleElements.get(obstacle.id);
                if (obstacleEl) {
                    obstacleEl.style.transform = `translateX(${obstacle.x}px) translateY(${obstacle.y}px)`;
                    if (obstacle.x < -50) {
                        obstacleEl.remove();
                        gameState.obstacleElements.delete(obstacle.id);
                        gameState.obstacles.splice(i, 1);
                    }
                }
            }
        }
        function checkCollisions() {
            const playerRect = { x: 50, y: gameState.playerY, width: 50, height: 50 };
            for (let obstacle of gameState.obstacles) {
                const obstacleRect = { x: obstacle.x, y: obstacle.y, width: 40, height: 40 };
                if (isColliding(playerRect, obstacleRect)) {
                    return true;
                }
            }
            return false;
        }
        function isColliding(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width && rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height && rect1.y + rect1.height > rect2.y;
        }
        let dragThrottle = false;
        function startDrag(e) {
            if (!gameState.isPlaying || gameState.isPaused) return;
            e.preventDefault();
            gameState.isDragging = true;
            elements.playerKite.style.cursor = 'grabbing';
            playSound('move');
        }
        function startDragTouch(e) {
            if (!gameState.isPlaying || gameState.isPaused) return;
            e.preventDefault();
            gameState.isDragging = true;
            playSound('move');
        }
        function handleDrag(e) {
            if (!gameState.isDragging || !gameState.isPlaying || gameState.isPaused || dragThrottle) return;
            dragThrottle = true;
            requestAnimationFrame(() => {
                const rect = elements.gameArea.getBoundingClientRect();
                const mouseY = e.clientY - rect.top;
                updatePlayerPositionOptimized(mouseY);
                dragThrottle = false;
            });
        }
        function handleDragTouch(e) {
            if (!gameState.isDragging || !gameState.isPlaying || gameState.isPaused || dragThrottle) return;
            e.preventDefault();
            dragThrottle = true;
            requestAnimationFrame(() => {
                const rect = elements.gameArea.getBoundingClientRect();
                const touchY = e.touches[0].clientY - rect.top;
                updatePlayerPositionOptimized(touchY);
                dragThrottle = false;
            });
        }
        function stopDrag() {
            if (!gameState.isDragging) return;
            gameState.isDragging = false;
            elements.playerKite.style.cursor = 'grab';
        }
        function updatePlayerPositionOptimized(targetY) {
            const minY = 25;
            const maxY = elements.gameArea.offsetHeight - 25;
            const clampedY = Math.max(minY, Math.min(maxY, targetY));
            gameState.playerY = clampedY - 25;
            elements.playerKite.style.transform = `translateY(${gameState.playerY}px)`;
            if (gameState.frameCount % 8 === 0 && gameState.particleCount < gameState.maxParticles) {
                createParticlesOptimized(75, clampedY);
            }
        }
        function movePlayer(direction) {
            if (!gameState.isPlaying || gameState.isPaused) return;
            const moveAmount = 30;
            const newY = gameState.playerY + (direction * moveAmount);
            const minY = 0;
            const maxY = elements.gameArea.offsetHeight - 50;
            const clampedY = Math.max(minY, Math.min(maxY, newY));
            if (clampedY !== gameState.playerY) {
                gameState.playerY = clampedY;
                elements.playerKite.style.transform = `translateY(${gameState.playerY}px)`;
                playSound('move');
                if (gameState.particleCount < gameState.maxParticles) {
                    createParticlesOptimized(75, gameState.playerY + 25);
                }
            }
        }
        function handleKeyDown(e) {
            switch(e.key) {
                case 'ArrowUp': case 'w': case 'W': e.preventDefault(); movePlayer(-1); break;
                case 'ArrowDown': case 's': case 'S': e.preventDefault(); movePlayer(1); break;
                case ' ': e.preventDefault(); if (gameState.gameStarted) { togglePause(); } else { startGame(); } break;
            }
        }
        function levelComplete() {
            gameState.isPlaying = false;
            playSound('levelUp');
            elements.gameMessage.textContent = `üéâ N√≠vel ${gameState.level} completo! Pontua√ß√£o: ${gameState.score}`;
            elements.gameMessage.classList.add('pulse');
            setTimeout(() => {
                elements.gameMessage.classList.remove('pulse');
                if (gameState.level < gameState.maxLevel) {
                    gameState.level++;
                    nextLevel();
                } else {
                    gameComplete();
                }
            }, 2000);
        }
        function nextLevel() {
            const config = levelConfigs[gameState.level];
            gameState.gameSpeed = config.speed;
            gameState.obstacleSpawnRate = config.spawnRate;
            gameState.phaseDuration = config.duration;
            clearObstacles();
            elements.pauseBtn.style.display = 'none';
            elements.gameControls.style.display = 'none';
            elements.phaseProgress.style.width = '0%';
            elements.kiteSelection.style.display = 'none';
            showLevelTransition();
            updateDisplay();
        }
        function gameComplete() {
            saveCompleteGameRecord();
            elements.gameMessage.textContent = `üèÜ PARAB√âNS! Voc√™ completou o jogo! Pontua√ß√£o final: ${gameState.score}`;
            resetGameInterface();
        }
        function gameOver() {
            gameState.isPlaying = false;
            playSound('crash');
            createExplosion(75, gameState.playerY + 25);
            elements.gameArea.classList.add('shake');
            setTimeout(() => elements.gameArea.classList.remove('shake'), 500);
            elements.gameMessage.textContent = `üí• Colis√£o! Pontua√ß√£o: ${gameState.score} - Tente novamente!`;
            setTimeout(() => {
                resetGameInterface();
            }, 2000);
        }
        function resetGame() {
            stopBackgroundMusic();
            clearObstacles();
            initializeGame();
            updateDisplay();
            elements.gameMessage.textContent = 'Escolha sua pipa e clique em "Iniciar Corrida".';
        }
        function resetGameInterface() {
            elements.startBtn.style.display = 'inline-block';
            elements.pauseBtn.style.display = 'none';
            elements.kiteSelection.style.display = 'block';
            elements.gameControls.style.display = 'none';
            elements.phaseProgress.style.width = '0%';
            clearObstacles();
            gameState.gameStarted = false;
        }
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            if (gameState.isPaused) {
                elements.pauseBtn.textContent = 'Continuar';
                elements.gameMessage.textContent = 'Jogo pausado';
                stopBackgroundMusic();
            } else {
                elements.pauseBtn.textContent = 'Pausar';
                elements.gameMessage.textContent = `N√≠vel ${gameState.level} - Desvie!`;
                if (gameState.musicEnabled) { playBackgroundMusic(); }
                gameState.lastUpdateTime = performance.now();
                requestAnimationFrame(gameLoop);
            }
        }
        function clearObstacles() {
            gameState.obstacles = [];
            gameState.obstacleElements.forEach(el => el.remove());
            gameState.obstacleElements.clear();
            gameState.particleCount = 0;
            document.querySelectorAll('.particle').forEach(el => el.remove());
        }
        function updateDisplay() {
            elements.levelDisplay.textContent = `${gameState.level}/${gameState.maxLevel}`;
            elements.scoreDisplay.textContent = gameState.score.toLocaleString();
            elements.distanceDisplay.textContent = `${Math.floor(gameState.distance)}m`;
            const bestScore = getBestScore();
            elements.recordDisplay.textContent = bestScore ? bestScore.toLocaleString() : '-';
        }
        function createExplosion(x, y) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = `${x - 50}px`;
            explosion.style.top = `${y - 50}px`;
            elements.gameArea.appendChild(explosion);
            setTimeout(() => explosion.remove(), 500);
        }
        function createParticlesOptimized(x, y) {
            if (gameState.particleCount >= gameState.maxParticles) return;
            for (let i = 0; i < 3; i++) {
                if (gameState.particleCount >= gameState.maxParticles) break;
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${x + (Math.random() - 0.5) * 20}px`;
                particle.style.top = `${y + (Math.random() - 0.5) * 20}px`;
                elements.gameArea.appendChild(particle);
                gameState.particleCount++;
                setTimeout(() => { particle.remove(); gameState.particleCount--; }, 800);
            }
        }
        function createSpeedLines() {
            const line = document.createElement('div');
            line.style.position = 'absolute'; line.style.right = '0';
            line.style.top = `${Math.random() * elements.gameArea.offsetHeight}px`;
            line.style.width = '30px'; line.style.height = '2px';
            line.style.background = 'rgba(255, 255, 255, 0.5)';
            line.style.animation = 'drift 0.5s linear forwards';
            elements.gameArea.appendChild(line);
            setTimeout(() => line.remove(), 500);
        }
        function saveCompleteGameRecord() {
            const records = getRecords();
            const newRecord = {
                level: gameState.maxLevel, score: gameState.score, distance: gameState.distance,
                kite: gameState.selectedKite, date: new Date().toLocaleDateString('pt-BR'), complete: true
            };
            records.push(newRecord);
            records.sort((a, b) => b.score - a.score);
            records.splice(10);
            localStorage.setItem('kite-festival-records', JSON.stringify(records));
        }
        function getRecords() {
            const stored = localStorage.getItem('kite-festival-records');
            return stored ? JSON.parse(stored) : [];
        }
        function getBestScore() {
            const records = getRecords();
            return records.length > 0 ? records[0].score : 0;
        }
        function loadRecords() {
            updateDisplay();
        }
        function showLeaderboard() {
            const records = getRecords();
            const listEl = document.getElementById('leaderboardList');
            if (records.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #666;">Nenhum recorde ainda.</p>';
            } else {
                listEl.innerHTML = records.map((record, index) => `
                    <div class="leaderboard-item">
                        <div class="rank">#${index + 1}</div>
                        <div class="record-info">
                            <div class="record-level">${record.complete ? 'üèÜ Jogo Completo' : `N√≠vel ${record.level}`} - ${record.kite}</div>
                            <div class="record-score">${record.score.toLocaleString()} pts ‚Ä¢ ${Math.floor(record.distance)}m ‚Ä¢ ${record.date}</div>
                        </div>
                    </div>`).join('');
            }
            elements.leaderboardModal.style.display = 'flex';
        }
        function closeLeaderboard() {
            elements.leaderboardModal.style.display = 'none';
        }
        function clearRecords() {
            if (confirm('Tem certeza que deseja limpar todos os recordes?')) {
                localStorage.removeItem('kite-festival-records');
                showLeaderboard();
                updateDisplay();
            }
        }
        function createSynthAudio() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                window.synthAudio = {
                    play: (type, config) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.type = config.type || 'sine';
                        gainNode.gain.setValueAtTime(config.startVol, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(config.startFreq, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + config.duration);
                        oscillator.frequency.exponentialRampToValueAtTime(config.endFreq, audioContext.currentTime + config.duration);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + config.duration);
                    },
                    playSequence: (notes) => {
                        notes.forEach((note, index) => {
                            setTimeout(() => {
                                window.synthAudio.play('custom', { type: 'sine', startVol: 0.1, startFreq: note, endFreq: note, duration: 0.2 });
                            }, index * 100);
                        });
                    }
                };
            } catch (e) { console.log('Web Audio API n√£o suportada.'); window.synthAudio = null; }
        }
        function playSound(type) {
            if (!gameState.soundEnabled || !window.synthAudio) return;
            const sounds = {
                move: { startVol: 0.1, startFreq: 800, endFreq: 400, duration: 0.1 },
                crash: { type: 'sawtooth', startVol: 0.2, startFreq: 200, endFreq: 50, duration: 0.5 },
                levelUp: [523.25, 659.25, 783.99, 1046.50]
            };
            if (type === 'levelUp') {
                window.synthAudio.playSequence(sounds.levelUp);
            } else if (sounds[type]) {
                window.synthAudio.play(type, sounds[type]);
            }
        }
        function playBackgroundMusic() {}
        function stopBackgroundMusic() {}
        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            elements.musicToggle.classList.toggle('muted', !gameState.musicEnabled);
            if (gameState.musicEnabled && gameState.isPlaying && !gameState.isPaused) { playBackgroundMusic(); } 
            else { stopBackgroundMusic(); }
        }
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            elements.soundToggle.classList.toggle('muted', !gameState.soundEnabled);
        }
        function showLevelTransition() {
            let countdown = 3;
            elements.gameMessage.textContent = `Preparando N√≠vel ${gameState.level}... ${countdown}`;
            elements.gameMessage.classList.add('pulse');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    elements.gameMessage.textContent = `Preparando N√≠vel ${gameState.level}... ${countdown}`;
                } else {
                    elements.gameMessage.textContent = `N√≠vel ${gameState.level} - COME√áOU!`;
                    elements.gameMessage.classList.remove('pulse');
                    clearInterval(countdownInterval);
                    setTimeout(() => {
                        gameState.isPlaying = true;
                        gameState.isPaused = false;
                        gameState.phaseStartTime = Date.now();
                        gameState.lastUpdateTime = performance.now();
                        elements.pauseBtn.style.display = 'inline-block';
                        elements.gameControls.style.display = 'flex';
                        if (gameState.musicEnabled) playBackgroundMusic();
                        requestAnimationFrame(gameLoop);
                    }, 500);
                }
            }, 1000);
        }
    </script>
</body>
</html>
